
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Building PHP extensions &#8212; PHP 内幕</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Zval" href="../zvals.html" />
    <link rel="prev" title="编译 PHP" href="building_php.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PHP 内幕</span></a></h1>
        <h2 class="heading"><span>Building PHP extensions</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="building_php.html">编译 PHP</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="../zvals.html">Zval</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="building-php-extensions">
<h1>Building PHP extensions<a class="headerlink" href="#building-php-extensions" title="此标题的永久链接">¶</a></h1>
<p>Now that you know how to compile PHP itself, we’ll move on to compiling additional extensions. We’ll discuss how the
build process works and what different options are available.</p>
<section id="loading-shared-extensions">
<h2>Loading shared extensions<a class="headerlink" href="#loading-shared-extensions" title="此标题的永久链接">¶</a></h2>
<p>As you already know from the previous section, PHP extensions can be either built statically into the PHP binary, or
compiled into a shared object (<code class="docutils literal notranslate"><span class="pre">.so</span></code>). Static linkage is the default for most of the bundled extensions, whereas
shared objects can be created by explicitly passing <code class="docutils literal notranslate"><span class="pre">--enable-EXTNAME=shared</span></code> or <code class="docutils literal notranslate"><span class="pre">--with-EXTNAME=shared</span></code> to
<code class="docutils literal notranslate"><span class="pre">./configure</span></code>.</p>
<p>While static extensions will always be available, shared extensions need to be loaded using the <code class="docutils literal notranslate"><span class="pre">extension</span></code> or
<code class="docutils literal notranslate"><span class="pre">zend_extension</span></code> ini options. Both options take either an absolute path to the <code class="docutils literal notranslate"><span class="pre">.so</span></code> file or a path relative to
the <code class="docutils literal notranslate"><span class="pre">extension_dir</span></code> setting.</p>
<p>As an example, consider a PHP build compiled using this configure line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt; ./configure --prefix<span class="o">=</span><span class="nv">$HOME</span>/myphp <span class="se">\</span>
                       --enable-debug --enable-maintainer-zts <span class="se">\</span>
                       --enable-opcache --with-gmp<span class="o">=</span>shared
</pre></div>
</div>
<p>In this case both the opcache extension and GMP extension are compiled into shared objects located in the <code class="docutils literal notranslate"><span class="pre">modules/</span></code>
directory. You can load both either by changing the <code class="docutils literal notranslate"><span class="pre">extension_dir</span></code> or by passing absolute paths:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt; sapi/cli/php -dzend_extension<span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/modules/opcache.so <span class="se">\</span>
                        -dextension<span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/modules/gmp.so
<span class="c1"># or</span>
~/php-src&gt; sapi/cli/php -dextension_dir<span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/modules <span class="se">\</span>
                        -dzend_extension<span class="o">=</span>opcache.so -dextension<span class="o">=</span>gmp.so

<span class="c1"># or (since PHP 7.2 the .so is optional)</span>
~/php-src&gt; sapi/cli/php -dextension_dir<span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/modules <span class="se">\</span>
                        -dzend_extension<span class="o">=</span>opcache -dextension<span class="o">=</span>gmp
</pre></div>
</div>
<p>During the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> step, both <code class="docutils literal notranslate"><span class="pre">.so</span></code> files will be moved into the extension directory of your PHP installation,
which you may find using the <code class="docutils literal notranslate"><span class="pre">php-config</span> <span class="pre">--extension-dir</span></code> command. For the above build options it will be
<code class="docutils literal notranslate"><span class="pre">/home/myuser/myphp/lib/php/extensions/no-debug-non-zts-MODULE_API</span></code>. This value will also be the default of the
<code class="docutils literal notranslate"><span class="pre">extension_dir</span></code> ini option, so you won’t have to specify it explicitly and can load the extensions directly:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/myphp&gt; bin/php -dzend_extension<span class="o">=</span>opcache -dextension<span class="o">=</span>gmp
</pre></div>
</div>
<p>This leaves us with one question: Which mechanism should you use? Shared objects allow you to have a base PHP binary and
load additional extensions through the php.ini. Distributions make use of this by providing a bare PHP package and
distributing the extensions as separate packages. On the other hand, if you are compiling your own PHP binary, you
likely don’t have need for this, because you already know which extensions you need.</p>
<p>As a rule of thumb, you’ll use static linkage for the extensions bundled by PHP itself and use shared extensions for
everything else. The reason is simply that building external extensions as shared objects is easier (or at least less
intrusive), as you will see in a moment. Another benefit is that you can update the extension without rebuilding PHP.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If you need information about the difference between extensions and Zend extensions, you <a class="reference internal" href="../extensions_design/zend_extensions.html"><span class="doc">may have a
look at the dedicated chapter</span></a>.</p>
</div>
</section>
<section id="installing-extensions-from-pecl">
<h2>Installing extensions from PECL<a class="headerlink" href="#installing-extensions-from-pecl" title="此标题的永久链接">¶</a></h2>
<p><a class="reference external" href="http://pecl.php.net">PECL</a>, the <em>PHP Extension Community Library</em>, offers a large number of extensions for PHP. When extensions are removed
from the main PHP distribution, they usually continue to exist in PECL. Similarly, many extensions that are now bundled
with PHP were previously PECL extensions.</p>
<p>If you specified <code class="docutils literal notranslate"><span class="pre">--with-pear</span></code> during the configuration stage of your PHP build, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> will download
and install PECL as a part of PEAR. You will find the <code class="docutils literal notranslate"><span class="pre">pecl</span></code> script in the <code class="docutils literal notranslate"><span class="pre">$PREFIX/bin</span></code> directory. Installing
extensions is now as simple as running <code class="docutils literal notranslate"><span class="pre">pecl</span> <span class="pre">install</span> <span class="pre">EXTNAME</span></code>, e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/myphp&gt; bin/pecl install apcu
</pre></div>
</div>
<p>This command will download, compile and install the <a class="reference external" href="http://pecl.php.net/package/APCu">APCu</a> extension. The result will be a <code class="docutils literal notranslate"><span class="pre">apcu.so</span></code> file in your
extension directory, which can then be loaded by passing the <code class="docutils literal notranslate"><span class="pre">extension=apcu</span></code> ini option.</p>
<p>While <code class="docutils literal notranslate"><span class="pre">pecl</span> <span class="pre">install</span></code> is very handy for the end-user, it is of little interest to extension developers. In the
following, we’ll describe two ways to manually build extensions: Either by importing it into the main PHP source tree
(this allows static linkage) or by doing an external build (only shared).</p>
</section>
<section id="adding-extensions-to-the-php-source-tree">
<h2>Adding extensions to the PHP source tree<a class="headerlink" href="#adding-extensions-to-the-php-source-tree" title="此标题的永久链接">¶</a></h2>
<p>There is no fundamental difference between a third-party extension and an extension bundled with PHP. As such you can
build an external extension simply by copying it into the PHP source tree and then using the usual build procedure.
We’ll demonstrate this using APCu as an example.</p>
<p>First of all, you’ll have to place the source code of the extension into the <code class="docutils literal notranslate"><span class="pre">ext/EXTNAME</span></code> directory of your PHP
source tree. If the extension is available via git, this is as simple as cloning the repository from within <code class="docutils literal notranslate"><span class="pre">ext/</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src/ext&gt; git clone https://github.com/krakjoe/apcu.git
</pre></div>
</div>
<p>Alternatively you can also download a source tarball and extract it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/tmp&gt; wget http://pecl.php.net/get/apcu-4.0.2.tgz
/tmp&gt; tar xzf apcu-4.0.2.tgz
/tmp&gt; mkdir ~/php-src/ext/apcu
/tmp&gt; cp -r apcu-4.0.2/. ~/php-src/ext/apcu
</pre></div>
</div>
<p>The extension will contain a <code class="docutils literal notranslate"><span class="pre">config.m4</span></code> file, which specifies extension-specific build instructions for use by
autoconf. To incorporate them into the <code class="docutils literal notranslate"><span class="pre">./configure</span></code> script, you’ll have to run <code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> again. To ensure that
the configure file is really regenerated, it is recommended to delete it beforehand:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt; rm configure <span class="o">&amp;&amp;</span> ./buildconf
</pre></div>
</div>
<p>You can now use the <code class="docutils literal notranslate"><span class="pre">./config.nice</span></code> script to add APCu to your existing configuration or start over with a completely
new configure line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt; ./config.nice --enable-apcu
<span class="c1"># or</span>
~/php-src&gt; ./configure --enable-apcu <span class="c1"># --other-options</span>
</pre></div>
</div>
<p>Finally run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-jN</span></code> to perform the actual build. As we didn’t use <code class="docutils literal notranslate"><span class="pre">--enable-apcu=shared</span></code> the extension is
statically linked into the PHP binary, i.e. no additional actions are needed to make use of it. Obviously you can also
use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> to install the resulting binaries.</p>
</section>
<section id="building-extensions-using-phpize">
<h2>Building extensions using <code class="docutils literal notranslate"><span class="pre">phpize</span></code><a class="headerlink" href="#building-extensions-using-phpize" title="此标题的永久链接">¶</a></h2>
<p>It is also possible to build extensions separately from PHP by making use of the <code class="docutils literal notranslate"><span class="pre">phpize</span></code> script that was already
mentioned in the <a class="reference internal" href="building_php.html#building-php"><span class="std std-ref">编译 PHP</span></a> section.</p>
<p><code class="docutils literal notranslate"><span class="pre">phpize</span></code> plays a similar role as the <code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> script used for PHP builds: First it will import the PHP build
system into your extension by copying files from <code class="docutils literal notranslate"><span class="pre">$PREFIX/lib/php/build</span></code>. Among these files are <code class="docutils literal notranslate"><span class="pre">php.m4</span></code>
(PHP’s M4 macros), <code class="docutils literal notranslate"><span class="pre">phpize.m4</span></code> (which will be renamed to <code class="docutils literal notranslate"><span class="pre">configure.ac</span></code> in your extension and contains the main
build instructions) and <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code>.</p>
<p>Then <code class="docutils literal notranslate"><span class="pre">phpize</span></code> will invoke autoconf to generate a <code class="docutils literal notranslate"><span class="pre">./configure</span></code> file, which can be used to customize the extension
build. Note that it is not necessary to pass <code class="docutils literal notranslate"><span class="pre">--enable-apcu</span></code> to it, as this is implicitly assumed. Instead you should
use <code class="docutils literal notranslate"><span class="pre">--with-php-config</span></code> to specify the path to your <code class="docutils literal notranslate"><span class="pre">php-config</span></code> script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/tmp/apcu-4.0.2&gt; ~/myphp/bin/phpize
Configuring <span class="k">for</span>:
PHP Api Version:         <span class="m">20121113</span>
Zend Module Api No:      <span class="m">20121113</span>
Zend Extension Api No:   <span class="m">220121113</span>

/tmp/apcu-4.0.2&gt; ./configure --with-php-config<span class="o">=</span><span class="nv">$HOME</span>/myphp/bin/php-config
/tmp/apcu-4.0.2&gt; make -jN <span class="o">&amp;&amp;</span> make install
</pre></div>
</div>
<p>You should always specify the <code class="docutils literal notranslate"><span class="pre">--with-php-config</span></code> option when building extensions (unless you have only a single,
global installation of PHP), otherwise <code class="docutils literal notranslate"><span class="pre">./configure</span></code> will not be able to correctly determine what PHP version and
flags to build against. Specifying the <code class="docutils literal notranslate"><span class="pre">php-config</span></code> script also ensures that <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> will move the generated
<code class="docutils literal notranslate"><span class="pre">.so</span></code> file (which can be found in the <code class="docutils literal notranslate"><span class="pre">modules/</span></code> directory) to the right extension directory.</p>
<p>As the <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code> file was also copied during the <code class="docutils literal notranslate"><span class="pre">phpize</span></code> stage, you can run the extension tests using
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> (or an explicit call to <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> target for removing compiled objects is also available and allows you to force a full rebuild of
the extension, should the incremental build fail after a change. Additionally phpize provides a cleaning option via
<code class="docutils literal notranslate"><span class="pre">phpize</span> <span class="pre">--clean</span></code>. This will remove all the files imported by <code class="docutils literal notranslate"><span class="pre">phpize</span></code>, as well as the files generated by the
<code class="docutils literal notranslate"><span class="pre">./configure</span></code> script.</p>
</section>
<section id="displaying-information-about-extensions">
<h2>Displaying information about extensions<a class="headerlink" href="#displaying-information-about-extensions" title="此标题的永久链接">¶</a></h2>
<p>The PHP CLI binary provides several options to display information about extensions. You already know <code class="docutils literal notranslate"><span class="pre">-m</span></code>, which will
list all loaded extensions. You can use it to verify that an extension was loaded correctly:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; ./php -dextension<span class="o">=</span>apcu -m <span class="p">|</span> grep apcu
apcu
</pre></div>
</div>
<p>There are several further switches beginning with <code class="docutils literal notranslate"><span class="pre">--r</span></code> that expose Reflection functionality. For example you can use
<code class="docutils literal notranslate"><span class="pre">--ri</span></code> to display the configuration of an extension:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; ./php -dextension<span class="o">=</span>apcu --ri apcu
apcu

APCu <span class="nv">Support</span> <span class="o">=</span>&gt; disabled
<span class="nv">Version</span> <span class="o">=</span>&gt; <span class="m">4</span>.0.2
APCu <span class="nv">Debugging</span> <span class="o">=</span>&gt; Disabled
MMAP <span class="nv">Support</span> <span class="o">=</span>&gt; Enabled
MMAP File <span class="nv">Mask</span> <span class="o">=</span>&gt;
Serialization <span class="nv">Support</span> <span class="o">=</span>&gt; broken
<span class="nv">Revision</span> <span class="o">=</span>&gt; <span class="nv">$Revision</span>: <span class="m">328290</span> $
Build <span class="nv">Date</span> <span class="o">=</span>&gt; Jan  <span class="m">1</span> <span class="m">2014</span> <span class="m">16</span>:40:00

<span class="nv">Directive</span> <span class="o">=</span>&gt; Local <span class="nv">Value</span> <span class="o">=</span>&gt; Master Value
apc.enabled <span class="o">=</span>&gt; <span class="nv">On</span> <span class="o">=</span>&gt; On
apc.shm_segments <span class="o">=</span>&gt; <span class="nv">1</span> <span class="o">=</span>&gt; <span class="m">1</span>
apc.shm_size <span class="o">=</span>&gt; <span class="nv">32M</span> <span class="o">=</span>&gt; 32M
apc.entries_hint <span class="o">=</span>&gt; <span class="nv">4096</span> <span class="o">=</span>&gt; <span class="m">4096</span>
apc.gc_ttl <span class="o">=</span>&gt; <span class="nv">3600</span> <span class="o">=</span>&gt; <span class="m">3600</span>
apc.ttl <span class="o">=</span>&gt; <span class="nv">0</span> <span class="o">=</span>&gt; <span class="m">0</span>
<span class="c1"># ...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--re</span></code> switch lists all ini settings, constants, functions and classes added by an extension:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; ./php -dextension=apcu --re apcu
Extension [ &lt;persistent&gt; extension #27 apcu version 4.0.2 ] {
  - INI {
    Entry [ apc.enabled &lt;SYSTEM&gt; ]
      Current = &#39;1&#39;
    }
    Entry [ apc.shm_segments &lt;SYSTEM&gt; ]
      Current = &#39;1&#39;
    }
    # ...
  }

  - Constants [1] {
    Constant [ boolean APCU_APC_FULL_BC ] { 1 }
  }

  - Functions {
    Function [ &lt;internal:apcu&gt; function apcu_cache_info ] {

      - Parameters [2] {
        Parameter #0 [ &lt;optional&gt; $type ]
        Parameter #1 [ &lt;optional&gt; $limited ]
      }
    }
    # ...
  }
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--re</span></code> switch only works for normal extensions, Zend extensions use <code class="docutils literal notranslate"><span class="pre">--rz</span></code> instead. You can try this on
opcache:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; ./php -dzend_extension<span class="o">=</span>opcache --rz <span class="s2">&quot;Zend OPcache&quot;</span>
Zend Extension <span class="o">[</span> Zend OPcache <span class="m">7</span>.0.3-dev Copyright <span class="o">(</span>c<span class="o">)</span> <span class="m">1999</span>-2013 by Zend Technologies &lt;http://www.zend.com/&gt; <span class="o">]</span>
</pre></div>
</div>
<p>As you can see, this doesn’t display any useful information. The reason is that opcache registers both a normal
extension and a Zend extension, where the former contains all ini settings, constants and functions. So in this
particular case you still need to use <code class="docutils literal notranslate"><span class="pre">--re</span></code>. Other Zend extensions make their information available via <code class="docutils literal notranslate"><span class="pre">--rz</span></code>
though.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="building_php.html">编译 PHP</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="../zvals.html">Zval</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        本书籍的存储库位于 <a href="https://github.com/mowangjuanzi/PHP-Internals-Book-zh-hans">GitHub</a>。
        <br/><br/>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
        </a>
        <br />
        PHP 内幕根据<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际</a>获得许可。
    </div>
    <script>
<!--      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){-->
<!--      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),-->
<!--      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)-->
<!--      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');-->

<!--      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');-->
<!--      ga('send', 'pageview');-->
    </script>

  </body>
</html>