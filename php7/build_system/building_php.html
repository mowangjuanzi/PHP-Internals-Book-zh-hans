
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>编译 PHP &#8212; PHP 内幕</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="canonical" href="https://phpinternals.kuphp.co/php7/build_system/building_php.html" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Building PHP extensions" href="building_extensions.html" />
    <link rel="prev" title="使用 PHP 编译系统" href="../build_system.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>PHP 内幕</span></a></h1>
        <h2 class="heading"><span>编译 PHP</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="../build_system.html">使用 PHP 编译系统</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="building_extensions.html">Building PHP extensions</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="php">
<span id="building-php"></span><h1>编译 PHP<a class="headerlink" href="#php" title="此标题的永久链接">¶</a></h1>
<p>本章解释了如何以适合扩展开发和核心修改的方式编译 PHP。 我们只涵盖了类 UNIX 系统。如果想要在 Windows 中编译 PHP，应该查看 PHP WIKI
中的 <a class="reference external" href="https://wiki.php.net/internals/windows/stepbystepbuild_sdk_2">step-by-step build instructions</a> <a class="footnote-reference brackets" href="#id3" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>。</p>
<p>本章还概述了 PHP 构建系统的工作原理及其使用的工具，但对它的详细描述超出了本书的范围。</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id3" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>免责声明：对尝试在 Windows 上编译 PHP 造成的任何不良健康影响，我们概不负责。</p>
</aside>
</aside>
<section id="id4">
<h2>为什么不使用包？<a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h2>
<p>如果你当前正在使用 PHP，可能会使用 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">php</span></code> 之类的命令通过包管理器安装
PHP。在解释实际的编译之前，应该首先了解为什么需要自己编译，而不能只使用预编译的。原因有很多：</p>
<p>首先，预编译包只会提供生成的二进制文件，但会缺少编译扩展必需的其它内容，比如：头文件。这可以通过安装开发包（通常称为
<code class="docutils literal notranslate"><span class="pre">php-dev</span></code>）解决。为了便于使用 valgrind 或 gdb 进行调试，可以安装调试符号，这通常另外一个由称为 <code class="docutils literal notranslate"><span class="pre">php-dbg</span></code>
的包提供这些符号。</p>
<p>但即使安装了头文件和调试符号，你仍然会使用 PHP 的发行版本。这意味着 PHP 将以高优化级别编译，这会使调试变得困难。
另外发行版本也不启用断言，也不生成有关内存泄露的警告。还有，预编译包也不启用线程安全，这可能有助于确保扩展在线程安装配置中构建。</p>
<p>还有一个问题是几乎所有的发行版都对 PHP 应用了额外的补丁。在某些情况下，这些补丁仅包含于配置相关的微小更改，但也有一些发行版使用了 Suhosin
等具有高度浸入的补丁。众所周知，其中一些补丁与低级扩展（如 opcache）有不兼容的内容。</p>
<p>PHP 只会为 <a class="reference external" href="http://www.php.net">php.net</a> 上提供的软件提供支持，不为分发修改后的版本提供支持。如果想要报告
bug、提交补丁、或者使用我们的帮助渠道编写扩展，应该始终使用官方 PHP 版本。当我们在本书中谈论“PHP”时，始终说的是官方支持的版本。</p>
</section>
<section id="id5">
<h2>获取源代码<a class="headerlink" href="#id5" title="此标题的永久链接">¶</a></h2>
<p>在编译 PHP 之前，首先需要获取源代码。有两种方式：从 <a class="reference external" href="http://www.php.net/downloads.php">PHP 下载页面</a> 下载归档文件或从 <a class="reference external" href="http://www.github.com/php/php-src">Github</a> 克隆 git 存储库。</p>
<p>两者的构建过程略有不同：git 存储库不捆绑 <code class="docutils literal notranslate"><span class="pre">configure</span></code> 脚本，所以需要使用 <code class="docutils literal notranslate"><span class="pre">buildconf</span></code> 脚本生成，该脚本利用了 autoconf。另外，git
存储库不包含预生成的 lexer 和 parser，还需要安装 re2c 和 bison。</p>
<p>建议从 git 检出源代码，因为这将会提供一个简单的方法来保持更新并尝试使用不同版本的代码。如果你香味 PHP 提交补丁或者拉取请求，也需要 git 检出。</p>
<p>在终端中克隆存储库，运行下列命令:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~&gt;<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/php/php-src.git
~&gt;<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>php-src
<span class="c1"># 默认是 master 分支，这是当前</span>
<span class="c1"># 开发版本。可以检出到稳定分支：</span>
~/php-src&gt;<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>PHP-8.1
</pre></div>
</div>
<p>如果对检出有问题，请查看 PHP wiki 上的 <a class="reference external" href="https://wiki.php.net/vcs/gitfaq">Git 问答</a>。如果想对 PHP 本身做贡献，Git FAQ 还解释了如何设置 git。另外还包含为多个
PHP 版本设置多个工作目录的说明。如果需要针对多个 PHP 版本和配置测试扩展或者更改，这非常有用。</p>
<p>进行下一步之前，应该使用包管理器安装一些基本的编译依赖项（默认已经安装了三个）：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gcc</span></code> 和 <code class="docutils literal notranslate"><span class="pre">g++</span></code> 或者一些编译器工具链。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">libc-dev</span></code> 提供 C 标准库，包括头文件。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span></code> 这是 PHP 使用的编译管理工具。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">autoconf</span></code> 用于生成 <code class="docutils literal notranslate"><span class="pre">configure</span></code> 脚本。</p>
<ul>
<li><p>2.59 或更高（用于 PHP 7.0-7.1）</p></li>
<li><p>2.64 或更高（用于 PHP 7.2）</p></li>
<li><p>2.68 或更高（用于 PHP 7.3 及其更高）</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">libtool</span></code>，帮助管理共享库。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bison</span></code> 用于生成 PHP 解析器。</p>
<ul>
<li><p>2.4 或更高（用于 7.0-7.3）</p></li>
<li><p>3.0 或更高（用于 PHP 7.4 及其更高）</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">re2c</span></code>，用于生成 PHP 词法分析器。</p>
<ul>
<li><p>PHP &lt;= 7.3 时可选</p></li>
<li><p>0.13.4 或更高（用于 PHP 7.4 及其更高）</p></li>
</ul>
</li>
</ul>
<p>在 Debian/Ubuntu 上，可以使用下列命令安装所有:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>build-essential<span class="w"> </span>autoconf<span class="w"> </span>libtool<span class="w"> </span>bison<span class="w"> </span>re2c<span class="w"> </span>pkg-config
</pre></div>
</div>
<p>根据 <code class="docutils literal notranslate"><span class="pre">./configure</span></code> 阶段启用的扩展，PHP 将需要很多额外的库。安装时，将检查是否有 <code class="docutils literal notranslate"><span class="pre">-dev</span></code> 或 <code class="docutils literal notranslate"><span class="pre">-devel</span></code>
结尾的软件包版本，然后安装它们。没有 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 的包通常不包含必要的头文件。例如，默认的 PHP 编译将需要 libxml 和
libsqlite3，可以通过 <code class="docutils literal notranslate"><span class="pre">libxml2-dev</span></code> 和 <code class="docutils literal notranslate"><span class="pre">libsqlite3-dev</span></code> 包安装。</p>
</section>
<section id="id7">
<h2>编译概述<a class="headerlink" href="#id7" title="此标题的永久链接">¶</a></h2>
<p>在仔细研究每个编译步骤的作用之前，这里时需要为“默认”PHP 编译执行的命令:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>./buildconf<span class="w">     </span><span class="c1"># 只有从 git 编译时才需要</span>
~/php-src&gt;<span class="w"> </span>./configure
~/php-src&gt;<span class="w"> </span>make<span class="w"> </span>-jN
</pre></div>
</div>
<p>为了快速编译，替换 <code class="docutils literal notranslate"><span class="pre">N</span></code> 为有效的 CPU 内核数（可以运行 <code class="docutils literal notranslate"><span class="pre">nproc</span></code> 来确定）。</p>
<p>默认 PHP 将为 CLI 和 CGI SAPI 编译二进制文件，分别位于 <code class="docutils literal notranslate"><span class="pre">sapi/cli/php</span></code> 和
<code class="docutils literal notranslate"><span class="pre">sapi/cgi/php-cgi</span></code>。要检查是否一切顺利，请尝试运行 <code class="docutils literal notranslate"><span class="pre">sapi/cli/php</span> <span class="pre">-v</span></code>。</p>
<p>此外，可以运行 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">make</span> <span class="pre">install</span></code> 将 PHP 安装到 <code class="docutils literal notranslate"><span class="pre">/usr/local</span></code>。可以在配置阶段指定 <code class="docutils literal notranslate"><span class="pre">--prefix</span></code> 来更改目标目录:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>./configure<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/myphp
~/php-src&gt;<span class="w"> </span>make<span class="w"> </span>-jN
~/php-src&gt;<span class="w"> </span>make<span class="w"> </span>install
</pre></div>
</div>
<p>这里的 <code class="docutils literal notranslate"><span class="pre">$HOME/myphp</span></code> 时在 <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> 步骤中使用的安装位置。注意，安装 PHP
不是必需的，但想要在扩展开发之外使用 PHP 编译则可能会很方便。</p>
<p>现在睁大双眼看每个编译步骤吧！</p>
</section>
<section id="buildconf">
<h2><code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> 脚本<a class="headerlink" href="#buildconf" title="此标题的永久链接">¶</a></h2>
<p>如果从 git 存储库编译，第一件事就是运行 <code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> 脚本。该脚本只是调用 <code class="docutils literal notranslate"><span class="pre">build/build.mk</span></code> makefile，又调用 <code class="docutils literal notranslate"><span class="pre">build/build2.mk</span></code>。</p>
<p>这些 makefile 的主要工作是运行 <code class="docutils literal notranslate"><span class="pre">autoconf</span></code> 生成 <code class="docutils literal notranslate"><span class="pre">./configure</span></code> 脚本和 <code class="docutils literal notranslate"><span class="pre">autoheader</span></code> 生成 <code class="docutils literal notranslate"><span class="pre">main/php_config.h.in</span></code>
模板。后面的文件会被配置生成最终的配置头文件 <code class="docutils literal notranslate"><span class="pre">main/php_config.h</span></code>。</p>
<p>Both utilities produce their results from the <code class="docutils literal notranslate"><span class="pre">configure.ac</span></code> file (which specifies most of the PHP build process),
the <code class="docutils literal notranslate"><span class="pre">build/php.m4</span></code> file (which specifies a large number of PHP-specific M4 macros) and the <code class="docutils literal notranslate"><span class="pre">config.m4</span></code> files of
individual extensions and SAPIs (as well as a bunch of other <a class="reference external" href="http://www.gnu.org/software/m4/m4.html">m4 files</a>).</p>
<p>好消息是编写扩展甚至进行核心修改都不需要跟编译系统进行太多交互。稍后需要编写小的 <code class="docutils literal notranslate"><span class="pre">config.m4</span></code> 文件，但这些文件通常只使用
<code class="docutils literal notranslate"><span class="pre">build/php.m4</span></code> 提供的两到三个高级宏。因此，不会再这里进一步详细介绍。</p>
<p><code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> 脚本只有两个选项：<code class="docutils literal notranslate"><span class="pre">--debug</span></code> 将在调用 autoconf 和 autoheader 时禁用警告抑制。除非在编译系统上工作，否则不会对这个选项感兴趣。</p>
<p>第二个选项是 <code class="docutils literal notranslate"><span class="pre">--force</span></code>，允许在发行包中运行 <code class="docutils literal notranslate"><span class="pre">./buildconf``（例如，下载了打包的源代码并想生成新的</span>
<span class="pre">``./configure</span></code>）并另外清除配置缓存 <code class="docutils literal notranslate"><span class="pre">config.cache</span></code> 和 <code class="docutils literal notranslate"><span class="pre">autom4te.cache/</span></code>。</p>
<p>如果使用 <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code> （或其它命令）更新 git 存储库在 <code class="docutils literal notranslate"><span class="pre">make</span></code> 阶段出现奇怪的错误，这通常意味着编译配置中的某些内容发生了变化，需要重新运行
<code class="docutils literal notranslate"><span class="pre">./buildconf</span></code>。</p>
</section>
<section id="configure">
<h2><code class="docutils literal notranslate"><span class="pre">./configure</span></code> 脚本<a class="headerlink" href="#configure" title="此标题的永久链接">¶</a></h2>
<p>一旦生成了 <code class="docutils literal notranslate"><span class="pre">./configure</span></code> ，就可以使用它来自定义 PHP 编译。可以使用 <code class="docutils literal notranslate"><span class="pre">--help</span></code> 列出所有支持的选项:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>./configure<span class="w"> </span>--help<span class="w"> </span><span class="p">|</span><span class="w"> </span>less
</pre></div>
</div>
<p>帮助的第一部分将列出各种通用选项，所有基于 autoconf 的配置脚本都支持这些选项。其中一个是已经提到的 <code class="docutils literal notranslate"><span class="pre">--prefix=DIR</span></code>，用于更改
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> 的安装目录。另外一个有用的选项是 <code class="docutils literal notranslate"><span class="pre">-C</span></code>，会将各种测试的结果缓存到 <code class="docutils literal notranslate"><span class="pre">config.cache</span></code> 文件中，并加快后续的
<code class="docutils literal notranslate"><span class="pre">./configure</span></code> 调用。只有当存在可用的编译并且想要在不同配置间快速切换时，此选项才有意义。</p>
<p>除了通用的 autoconf 选项之外，还有很多特定于 PHP 的选项。例如，使用 <code class="docutils literal notranslate"><span class="pre">--enable-NAME</span></code> 和 <code class="docutils literal notranslate"><span class="pre">--disable-NAME</span></code> 开关选择编译哪些扩展和
SAPI。如果扩展或 SAPI 具有外部依赖项，则需要使用 <code class="docutils literal notranslate"><span class="pre">--with-NAME</span></code> and <code class="docutils literal notranslate"><span class="pre">--without-NAME</span></code> 代替。</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">NAME</span></code> 需要的库不在默认位置（例如自己编译的），一些扩展允许使用 <code class="docutils literal notranslate"><span class="pre">--with-NAME=DIR</span></code> 指定它的位置。但是，由于 PHP 7.4
大多数扩展改用 <code class="docutils literal notranslate"><span class="pre">pkg-config</span></code>，在这种情况下将目录传递给 <code class="docutils literal notranslate"><span class="pre">--with</span></code> 没有作用。这时候，需要将库添加到 <code class="docutils literal notranslate"><span class="pre">PKG_CONFIG_PATH</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PKG_CONFIG_PATH</span><span class="o">=</span>/path/to/library/lib/pkgconfig:<span class="nv">$PKG_CONFIG_PATH</span>
</pre></div>
</div>
<p>PHP 默认将编译 CLI 和 CGI SAPI，以及一些扩展。可以使用 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 选项找出 PHP 二进制文件包含哪些扩展。对于默认编译的 PHP 7.0，结果将如下所示：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/php-src&gt; sapi/cli/php -m
[PHP Modules]
Core
ctype
date
dom
fileinfo
filter
hash
iconv
json
libxml
pcre
PDO
pdo_sqlite
Phar
posix
Reflection
session
SimpleXML
SPL
sqlite3
standard
tokenizer
xml
xmlreader
xmlwriter
</pre></div>
</div>
<p>如果想现在停止编译 CGI SAPI 以及 <em>tokenizer</em> 和 <em>sqlite3</em> 扩展，而是启用 <em>opcache</em> 和 <em>gmp</em>，相应的配置命令是:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>./configure<span class="w"> </span>--disable-cgi<span class="w"> </span>--disable-tokenizer<span class="w"> </span>--without-sqlite3<span class="w"> </span><span class="se">\</span>
<span class="w">                       </span>--enable-opcache<span class="w"> </span>--with-gmp
</pre></div>
</div>
<p>默认大部分扩展将被静态编译，即它们将成为生成二进制文件的一部分。默认仅共享 opcache
扩展，即将在 <code class="docutils literal notranslate"><span class="pre">modules/</span></code> 目录中生成 <code class="docutils literal notranslate"><span class="pre">opcache.so</span></code> 共享对象。可以通过编写 <code class="docutils literal notranslate"><span class="pre">--enable-NAME=shared</span></code> 或 <code class="docutils literal notranslate"><span class="pre">--with-NAME=shared</span></code>
将其它扩展编译为共享对象（并非所有扩展都支持）。下一节会讨论如何使用共享扩展。</p>
<p>要了解需要使用哪种开关以及默认情况下是否启用扩展，请查看 <code class="docutils literal notranslate"><span class="pre">./configure</span> <span class="pre">--help</span></code>。如果开关是 <code class="docutils literal notranslate"><span class="pre">--enable-NAME</span></code> 或 <code class="docutils literal notranslate"><span class="pre">--with-NAME</span></code>
意味着默认不编译扩展，需要手动启用。<code class="docutils literal notranslate"><span class="pre">--disable-NAME</span></code> 或 <code class="docutils literal notranslate"><span class="pre">--without-NAME</span></code> 另一方面表示扩展默认编译，但可以手动禁用。</p>
<p>一些扩展始终编译且不能禁用。使用 <code class="docutils literal notranslate"><span class="pre">--disable-all</span></code> 选项创建仅包含最少量扩展的编译:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>./configure<span class="w"> </span>--disable-all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>-jN
~/php-src&gt;<span class="w"> </span>sapi/cli/php<span class="w"> </span>-m
<span class="o">[</span>PHP<span class="w"> </span>Modules<span class="o">]</span>
Core
date
<span class="nb">hash</span>
json
pcre
Reflection
SPL
standard
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">--disable-all</span></code> 选项对想要快速编译且不需要太多功能时非常有用（例如，实现语言更改）。对于尽可能下的编译，可以额外指定 <code class="docutils literal notranslate"><span class="pre">--disable-cgi</span></code>
开关，只生成 CLI 二进制文件。</p>
<p>There are three more switches, which you should usually specify when developing extensions or working on PHP:</p>
<p><code class="docutils literal notranslate"><span class="pre">--enable-debug</span></code> enables debug mode, which has multiple effects: Compilation will run with <code class="docutils literal notranslate"><span class="pre">-g</span></code> to generate debug
symbols and additionally use the lowest optimization level <code class="docutils literal notranslate"><span class="pre">-O0</span></code>. This will make PHP a lot slower, but make debugging
with tools like <code class="docutils literal notranslate"><span class="pre">gdb</span></code> more predictable. Furthermore debug mode defines the <code class="docutils literal notranslate"><span class="pre">ZEND_DEBUG</span></code> macro, which will enable
the use of assertions and enable various debugging helpers in the engine. Among other things memory leaks, as well as
incorrect use of some data structures, will be reported. It is possible to enable debug assertions without disabling
optimizations by using <code class="docutils literal notranslate"><span class="pre">--enable-debug-assertions</span></code> instead.</p>
<p><code class="docutils literal notranslate"><span class="pre">--enable-zts</span></code> (or <code class="docutils literal notranslate"><span class="pre">--enable-maintainer-zts</span></code> before PHP 8.0) enables thread-safety. This switch will define the
<code class="docutils literal notranslate"><span class="pre">ZTS</span></code> macro, which in turn will enable the whole TSRM (thread-safe resource manager) machinery used by PHP. Since
PHP 7 having this switch continuously enabled is much less important than on previous versions. It is primarily
important to make sure you included all the necessary boilerplate code. If you need more information about thread
safety and global memory management in PHP, you should read <a class="reference internal" href="../extensions_design/globals_management.html"><span class="doc">the globals management chapter</span></a></p>
<p><code class="docutils literal notranslate"><span class="pre">--enable-werror</span></code> (since PHP 7.4) enables the <code class="docutils literal notranslate"><span class="pre">-Werror</span></code> compiler flag, which will promote compiler warnings to
errors. Enabling this flag ensures that the PHP build remains warning free. However, generated warnings depend on the
used compiler, version and optimization options, so some compilers may not be usable with option.</p>
<p>On the other hand you should not use the <code class="docutils literal notranslate"><span class="pre">--enable-debug</span></code> option if you want to perform performance benchmarks for
your code. <code class="docutils literal notranslate"><span class="pre">--enable-zts</span></code> can also negatively impact runtime performance.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">--enable-debug</span></code> and <code class="docutils literal notranslate"><span class="pre">--enable-zts</span></code> change the ABI of the PHP binary, e.g. by adding additional arguments
to functions. As such, shared extensions compiled in debug mode will not be compatible with a PHP binary built in
release mode. Similarly a thread-safe extension (ZTS) is not compatible with a non-thread-safe PHP build (NTS).</p>
<p>Due to the ABI incompatibility <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> (and PECL install) will put shared extensions in different directories
depending on these options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$PREFIX/lib/php/extensions/no-debug-non-zts-API_NO</span></code> for release builds without ZTS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$PREFIX/lib/php/extensions/debug-non-zts-API_NO</span></code> for debug builds without ZTS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$PREFIX/lib/php/extensions/no-debug-zts-API_NO</span></code> for release builds with ZTS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$PREFIX/lib/php/extensions/debug-zts-API_NO</span></code> for debug builds with ZTS</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">API_NO</span></code> placeholder above refers to the <code class="docutils literal notranslate"><span class="pre">ZEND_MODULE_API_NO</span></code> and is just a date like <code class="docutils literal notranslate"><span class="pre">20100525</span></code>, which is
used for internal API versioning.</p>
<p>For most purposes the configuration switches described above should be sufficient, but of course <code class="docutils literal notranslate"><span class="pre">./configure</span></code>
provides many more options, which you’ll find described in the help.</p>
<p>Apart from passing options to configure, you can also specify a number of environment variables. Some of the more
important ones are documented at the end of the configure help output (<code class="docutils literal notranslate"><span class="pre">./configure</span> <span class="pre">--help</span> <span class="pre">|</span> <span class="pre">tail</span> <span class="pre">-25</span></code>).</p>
<p>For example you can use <code class="docutils literal notranslate"><span class="pre">CC</span></code> to use a different compiler and <code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> to change the used compilation flags:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>./configure<span class="w"> </span>--disable-all<span class="w"> </span><span class="nv">CC</span><span class="o">=</span>clang<span class="w"> </span><span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-O3 -march=native&quot;</span>
</pre></div>
</div>
<p>In this configuration the build will make use of clang (instead of gcc) and use a very high optimization level
(<code class="docutils literal notranslate"><span class="pre">-O3</span> <span class="pre">-march=native</span></code>).</p>
<p>An option that is particularly useful for development is <code class="docutils literal notranslate"><span class="pre">-fsanitize</span></code>, which allows you to detect memory corruption
and undefined behavior at runtime:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-fsanitize=address -fsanitize=undefined&quot;</span>
</pre></div>
</div>
<p>These options only work reliably since PHP 7.4 and will significantly slow down the generated PHP binary.</p>
</section>
<section id="make-make-install">
<h2><code class="docutils literal notranslate"><span class="pre">make</span></code> 和 <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code><a class="headerlink" href="#make-make-install" title="此标题的永久链接">¶</a></h2>
<p>After everything is configured, you can use <code class="docutils literal notranslate"><span class="pre">make</span></code> to perform the actual compilation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>make<span class="w"> </span>-jN<span class="w">    </span><span class="c1"># where N is the number of cores</span>
</pre></div>
</div>
<p>The main result of this operation will be PHP binaries for the enabled SAPIs (by default <code class="docutils literal notranslate"><span class="pre">sapi/cli/php</span></code> and
<code class="docutils literal notranslate"><span class="pre">sapi/cgi/php-cgi</span></code>), as well as shared extensions in the <code class="docutils literal notranslate"><span class="pre">modules/</span></code> directory.</p>
<p>Now you can run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> to install PHP into <code class="docutils literal notranslate"><span class="pre">/usr/local</span></code> (default) or whatever directory you specified using
the <code class="docutils literal notranslate"><span class="pre">--prefix</span></code> configure switch.</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> will do little more than copy a number of files to the new location. If you specified <code class="docutils literal notranslate"><span class="pre">--with-pear</span></code>
during configuration, it will also download and install PEAR. Here is the resulting tree of a default PHP build:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt; tree -L 3 -F ~/myphp

/home/myuser/myphp
|-- bin
|   |-- pear*
|   |-- peardev*
|   |-- pecl*
|   |-- phar -&gt; /home/myuser/myphp/bin/phar.phar*
|   |-- phar.phar*
|   |-- php*
|   |-- php-cgi*
|   |-- php-config*
|   `-- phpize*
|-- etc
|   `-- pear.conf
|-- include
|   `-- php
|       |-- ext/
|       |-- include/
|       |-- main/
|       |-- sapi/
|       |-- TSRM/
|       `-- Zend/
|-- lib
|   `-- php
|       |-- Archive/
|       |-- build/
|       |-- Console/
|       |-- data/
|       |-- doc/
|       |-- OS/
|       |-- PEAR/
|       |-- PEAR5.php
|       |-- pearcmd.php
|       |-- PEAR.php
|       |-- peclcmd.php
|       |-- Structures/
|       |-- System.php
|       |-- test/
|       `-- XML/
`-- php
    `-- man
        `-- man1/
</pre></div>
</div>
<p>A short overview of the directory structure:</p>
<ul class="simple">
<li><p><em>bin/</em> contains the SAPI binaries (<code class="docutils literal notranslate"><span class="pre">php</span></code> and <code class="docutils literal notranslate"><span class="pre">php-cgi</span></code>), as well as the <code class="docutils literal notranslate"><span class="pre">phpize</span></code> and <code class="docutils literal notranslate"><span class="pre">php-config</span></code> scripts.
It is also home to the various PEAR/PECL scripts.</p></li>
<li><p><em>etc/</em> contains configuration. Note that the default <em>php.ini</em> directory is <strong>not</strong> here.</p></li>
<li><p><em>include/php</em> contains header files, which are needed to build additional extensions or embed PHP in custom software.</p></li>
<li><p><em>lib/php</em> contains PEAR files. The <em>lib/php/build</em> directory includes files necessary for building extensions, e.g.
the <code class="docutils literal notranslate"><span class="pre">php.m4</span></code> file containing PHP’s M4 macros. If we had compiled any shared extensions those files would live
in a subdirectory of <em>lib/php/extensions</em>.</p></li>
<li><p><em>php/man</em> obviously contains man pages for the <code class="docutils literal notranslate"><span class="pre">php</span></code> command.</p></li>
</ul>
<p>As already mentioned, the default <em>php.ini</em> location is not <em>etc/</em>. You can display the location using the <code class="docutils literal notranslate"><span class="pre">--ini</span></code>
option of the PHP binary:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; ./php --ini
Configuration File (php.ini) Path: /home/myuser/myphp/lib
Loaded Configuration File:         (none)
Scan for additional .ini files in: (none)
Additional .ini files parsed:      (none)
</pre></div>
</div>
<p>As you can see the default <em>php.ini</em> directory is <code class="docutils literal notranslate"><span class="pre">$PREFIX/lib</span></code> (libdir) rather than <code class="docutils literal notranslate"><span class="pre">$PREFIX/etc</span></code> (sysconfdir). You
can adjust the default <em>php.ini</em> location using the <code class="docutils literal notranslate"><span class="pre">--with-config-file-path=PATH</span></code> configure option.</p>
<p>Also note that <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> will not create an ini file. If you want to make use of a <em>php.ini</em> file it is your
responsibility to create one. For example you could copy the default development configuration:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; cp ~/php-src/php.ini-development ~/myphp/lib/php.ini
~/myphp/bin&gt; ./php --ini
Configuration File (php.ini) Path: /home/myuser/myphp/lib
Loaded Configuration File:         /home/myuser/myphp/lib/php.ini
Scan for additional .ini files in: (none)
Additional .ini files parsed:      (none)
</pre></div>
</div>
<p>Apart from the PHP binaries the <em>bin/</em> directory also contains two important scripts: <code class="docutils literal notranslate"><span class="pre">phpize</span></code> and <code class="docutils literal notranslate"><span class="pre">php-config</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">phpize</span></code> is the equivalent of <code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> for extensions. It will copy various files from <em>lib/php/build</em> and
invoke autoconf/autoheader. You will learn more about this tool in the next section.</p>
<p><code class="docutils literal notranslate"><span class="pre">php-config</span></code> provides information about the configuration of the PHP build. Try it out:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/myphp/bin&gt; ./php-config
Usage: ./php-config [OPTION]
Options:
  --prefix            [/home/myuser/myphp]
  --includes          [-I/home/myuser/myphp/include/php -I/home/myuser/myphp/include/php/main -I/home/myuser/myphp/include/php/TSRM -I/home/myuser/myphp/include/php/Zend -I/home/myuser/myphp/include/php/ext -I/home/myuser/myphp/include/php/ext/date/lib]
  --ldflags           [ -L/usr/lib/i386-linux-gnu]
  --libs              [-lcrypt   -lresolv -lcrypt -lrt -lrt -lm -ldl -lnsl  -lxml2 -lxml2 -lxml2 -lcrypt -lxml2 -lxml2 -lxml2 -lcrypt ]
  --extension-dir     [/home/myuser/myphp/lib/php/extensions/debug-zts-20100525]
  --include-dir       [/home/myuser/myphp/include/php]
  --man-dir           [/home/myuser/myphp/php/man]
  --php-binary        [/home/myuser/myphp/bin/php]
  --php-sapis         [ cli cgi]
  --configure-options [--prefix=/home/myuser/myphp --enable-debug --enable-maintainer-zts]
  --version           [5.4.16-dev]
  --vernum            [50416]
</pre></div>
</div>
<p>The script is similar to the <code class="docutils literal notranslate"><span class="pre">pkg-config</span></code> script used by linux distributions. It is invoked during the extension
build process to obtain information about compiler options and paths. You can also use it to quickly get information
about your build, e.g. your configure options or the default extension directory. This information is also provided by
<code class="docutils literal notranslate"><span class="pre">./php</span> <span class="pre">-i</span></code> (phpinfo), but <code class="docutils literal notranslate"><span class="pre">php-config</span></code> provides it in a simpler form (which can be easily used by automated tools).</p>
</section>
<section id="id8">
<h2>运行测试套件<a class="headerlink" href="#id8" title="此标题的永久链接">¶</a></h2>
<p>If the <code class="docutils literal notranslate"><span class="pre">make</span></code> command finishes successfully, it will print a message encouraging you to run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Build complete.
Don&#39;t forget to run &#39;make test&#39;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> will run the PHP CLI binary against our test suite, which is located in the different <em>tests/</em> directories
of the PHP source tree. As a default build is run against more than 10000 (less for a minimal build, more if
you enable additional extensions) this can take several minutes.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> command internally invokes the <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code> file using your CLI binary. For more control, it is
recommended to invoke <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code> directly. For example, this will allow you to enable the parallel test runner:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>sapi/cli/php<span class="w"> </span>run-tests.php<span class="w"> </span>-jN
</pre></div>
</div>
<p>Test parallelism is only available as of PHP 7.4. On earlier PHP versions parallelism is not available, and it is
necessary to additionally pass the <code class="docutils literal notranslate"><span class="pre">-P</span></code> option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>sapi/cli/php<span class="w"> </span>run-tests.php<span class="w"> </span>-P
</pre></div>
</div>
<p>Instead of running the whole test suite, you can also limit it to certain directories by passing them as arguments to
<code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code>. E.g. to test only the Zend engine, the reflection extension and the array functions:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>sapi/cli/php<span class="w"> </span>run-tests.php<span class="w"> </span>-jN<span class="w"> </span>Zend/<span class="w"> </span>ext/reflection/<span class="w"> </span>ext/standard/tests/array/
</pre></div>
</div>
<p>This is very useful, because it allows you to quickly run only the parts of the test suite that are relevant to your
changes. E.g. if you are doing language modifications you likely don’t care about the extension tests and only want to
verify that the Zend engine is still working correctly.</p>
<p>You can run <code class="docutils literal notranslate"><span class="pre">sapi/cli/php</span> <span class="pre">run-tests.php</span> <span class="pre">--help</span></code> to display a full list of options the test runner accepts. Some
particularly useful options are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">php.ini</span></code> can be used to specify a php.ini file to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-d</span> <span class="pre">foo=bar</span></code> can be used to set ini options.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-m</span></code> runs tests under valgrind to detect memory errors. Note that this is extremely slow.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--asan</span></code> should be set when compiling PHP with <code class="docutils literal notranslate"><span class="pre">-fsanitize=address</span></code>. Together these are approximately
equivalent to running under valgrind, but with much better performance.</p></li>
</ul>
</div></blockquote>
<p>You don’t need to explicitly use <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code> to pass options or limit directories. Instead you can use the
<code class="docutils literal notranslate"><span class="pre">TESTS</span></code> variable to pass additional arguments via <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>. E.g. the equivalent of the previous command would
be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>make<span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="nv">TESTS</span><span class="o">=</span><span class="s2">&quot;-jN Zend/ ext/reflection/ ext/standard/tests/array/&quot;</span>
</pre></div>
</div>
<p>We will take a more detailed look at the <code class="docutils literal notranslate"><span class="pre">run-tests.php</span></code> system later, in particular also talk about how to write your
own tests and how to debug test failures. <a class="reference internal" href="../../tests/introduction.html"><span class="doc">See the dedicated tests chapter</span></a>.</p>
</section>
<section id="make-clean">
<h2>修复编译问题和 <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code><a class="headerlink" href="#make-clean" title="此标题的永久链接">¶</a></h2>
<p>As you may know <code class="docutils literal notranslate"><span class="pre">make</span></code> performs an incremental build, i.e. it will not recompile all files, but only those <code class="docutils literal notranslate"><span class="pre">.c</span></code>
files that changed since the last invocation. This is a great way to shorten build times, but it doesn’t always work
well: For example, if you modify a structure in a header file, <code class="docutils literal notranslate"><span class="pre">make</span></code> will not automatically recompile all <code class="docutils literal notranslate"><span class="pre">.c</span></code>
files making use of that header, thus leading to a broken build.</p>
<p>If you get odd errors while running <code class="docutils literal notranslate"><span class="pre">make</span></code> or the resulting binary is broken (e.g. if <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> crashes it before
it gets to run the first test), you should try to run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>. This will delete all compiled objects, thus
forcing the next <code class="docutils literal notranslate"><span class="pre">make</span></code> call to perform a full build. (You can use <code class="docutils literal notranslate"><span class="pre">ccache</span></code> to reduce the cost of rebuilds.)</p>
<p>Sometimes you also need to run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> after changing <code class="docutils literal notranslate"><span class="pre">./configure</span></code> options. If you only enable additional
extensions an incremental build should be safe, but changing other options may require a full rebuild.</p>
<p>Another source of compilation issues is the modification of <code class="docutils literal notranslate"><span class="pre">config.m4</span></code> files or other files that are part of the PHP
build system. If such a file is changed, it is necessary to rerun the <code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> and <code class="docutils literal notranslate"><span class="pre">./configure</span></code> scripts. If
you do the modification yourself, you will likely remember to run the command, but if it happens as part of a
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code> (or some other updating command) the issue might not be so obvious.</p>
<p>If you encounter any odd compilation problems that are not resolved by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>, chances are that running
<code class="docutils literal notranslate"><span class="pre">./buildconf</span></code> will fix the issue. To avoid typing out the previous <code class="docutils literal notranslate"><span class="pre">./configure</span></code> options afterwards, you can make
use of the <code class="docutils literal notranslate"><span class="pre">./config.nice</span></code> script (which contains your last <code class="docutils literal notranslate"><span class="pre">./configure</span></code> call):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/php-src&gt;<span class="w"> </span>make<span class="w"> </span>clean
~/php-src&gt;<span class="w"> </span>./buildconf<span class="w"> </span>--force
~/php-src&gt;<span class="w"> </span>./config.nice
~/php-src&gt;<span class="w"> </span>make<span class="w"> </span>-jN
</pre></div>
</div>
<p>One last cleaning script that PHP provides is <code class="docutils literal notranslate"><span class="pre">./vcsclean</span></code>. This will only work if you checked out the source code
from git. It effectively boils down to a call to <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clean</span> <span class="pre">-X</span> <span class="pre">-f</span> <span class="pre">-d</span></code>, which will remove all untracked files and
directories that are ignored by git. You should use this with care.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="../build_system.html">使用 PHP 编译系统</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="building_extensions.html">Building PHP extensions</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        本书籍的存储库位于 <a href="https://github.com/mowangjuanzi/PHP-Internals-Book-zh-hans">GitHub</a>。
        <br/><br/>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
        </a>
        <br />
        PHP 内幕根据<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际</a>获得许可。
    </div>
    <script>
<!--      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){-->
<!--      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),-->
<!--      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)-->
<!--      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');-->

<!--      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');-->
<!--      ga('send', 'pageview');-->
    </script>

  </body>
</html>